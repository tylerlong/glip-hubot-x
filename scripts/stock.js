// Commands:
//   hubot stock <ticker> - Get a stock price
const request = require('request')

module.exports = robot => {
  robot.respond(/stock (.+?)$/, res => {
    const symbol = res.match[1].toUpperCase()
    request(`https://www.quandl.com/api/v3/datasets/WIKI/${symbol}.json?api_key=hWMcYrZQW1uL-G5C6Grn&start_date=2018-02-01`, (error, response, body) => {
      if (error !== null) {
        res.send(`Failed to fetch quote for ${symbol}`)
        return
      }
      const json = JSON.parse(body)
      if (json.quandl_error) {
        res.send(json.quandl_error.message)
        return
      }
      const name = json.dataset.name.split(' Prices, ')[0]
      let result = json.dataset.data.slice(0, 1).map(date => `${date[0]}: **$${date[4]}**`).join('\n')
      result = `${name} ${result}`
      res.send(result)
    })
  })
}

/*
{
    {
  "dataset": {
    "id": 9775409,
    "dataset_code": "AAPL",
    "database_code": "WIKI",
    "name": "Apple Inc (AAPL) Prices, Dividends, Splits and Trading Volume",
    "description": "End of day open, high, low, close and volume, dividends and splits, and split/dividend adjusted open, high, low close and volume for Apple Inc. (AAPL). Ex-Dividend is non-zero on ex-dividend dates. Split Ratio is 1 on non-split dates. Adjusted prices are calculated per CRSP (<a href=\"http://www.crsp.com/products/documentation/crsp-calculations\" rel=\"nofollow\" target=\"blank\">www.crsp.com/products/documentation/crsp-calculations</a>)\r\n\r\n<p>This data is in the public domain. You may copy, distribute, disseminate or include the data in other products for commercial and/or noncommercial purposes.</p>\r\n<p>This data is part of Quandl's Wiki initiative to get financial data permanently into the public domain. Quandl relies on users like you to flag errors and provide data where data is wrong or missing. Get involved: <a href=\"mailto:connect@quandl.com\" rel=\"nofollow\" target=\"blank\">connect@quandl.com</a>",
    "refreshed_at": "2017-12-08T22:49:09.384Z",
    "newest_available_date": "2017-12-08",
    "oldest_available_date": "1980-12-12",
    "column_names": [
      "Date",
      "Open",
      "High",
      "Low",
      "Close",
      "Volume",
      "Ex-Dividend",
      "Split Ratio",
      "Adj. Open",
      "Adj. High",
      "Adj. Low",
      "Adj. Close",
      "Adj. Volume"
    ],
    "frequency": "daily",
    "type": "Time Series",
    "premium": false,
    "limit": null,
    "transform": null,
    "column_index": null,
    "start_date": "2017-11-01",
    "end_date": "2017-12-08",
    "data": [
      [
        "2017-12-08",
        170.49,
        171.0,
        168.82,
        169.37,
        23096872.0,
        0.0,
        1.0,
        170.49,
        171.0,
        168.82,
        169.37,
        23096872.0
      ],
      [
        "2017-12-07",
        169.03,
        170.44,
        168.91,
        169.452,
        24469613.0,
        0.0,
        1.0,
        169.03,
        170.44,
        168.91,
        169.452,
        24469613.0
      ],
      [
        "2017-12-06",
        167.5,
        170.2047,
        166.46,
        169.01,
        28224357.0,
        0.0,
        1.0,
        167.5,
        170.2047,
        166.46,
        169.01,
        28224357.0
      ],
      [
        "2017-12-05",
        169.06,
        171.52,
        168.4,
        169.64,
        27008428.0,
        0.0,
        1.0,
        169.06,
        171.52,
        168.4,
        169.64,
        27008428.0
      ],
      [
        "2017-12-04",
        172.48,
        172.62,
        169.63,
        169.8,
        32115052.0,
        0.0,
        1.0,
        172.48,
        172.62,
        169.63,
        169.8,
        32115052.0
      ],
      [
        "2017-12-01",
        169.95,
        171.67,
        168.5,
        171.05,
        39590080.0,
        0.0,
        1.0,
        169.95,
        171.67,
        168.5,
        171.05,
        39590080.0
      ],
      [
        "2017-11-30",
        170.43,
        172.14,
        168.44,
        171.85,
        40172368.0,
        0.0,
        1.0,
        170.43,
        172.14,
        168.44,
        171.85,
        40172368.0
      ],
      [
        "2017-11-29",
        172.63,
        172.92,
        167.16,
        169.48,
        40788324.0,
        0.0,
        1.0,
        172.63,
        172.92,
        167.16,
        169.48,
        40788324.0
      ],
      [
        "2017-11-28",
        174.3,
        174.87,
        171.86,
        173.07,
        25468442.0,
        0.0,
        1.0,
        174.3,
        174.87,
        171.86,
        173.07,
        25468442.0
      ],
      [
        "2017-11-27",
        175.05,
        175.08,
        173.34,
        174.09,
        20536313.0,
        0.0,
        1.0,
        175.05,
        175.08,
        173.34,
        174.09,
        20536313.0
      ],
      [
        "2017-11-24",
        175.1,
        175.5,
        174.6459,
        174.97,
        14026519.0,
        0.0,
        1.0,
        175.1,
        175.5,
        174.6459,
        174.97,
        14026519.0
      ],
      [
        "2017-11-22",
        173.36,
        175.0,
        173.05,
        174.96,
        24997274.0,
        0.0,
        1.0,
        173.36,
        175.0,
        173.05,
        174.96,
        24997274.0
      ],
      [
        "2017-11-21",
        170.78,
        173.7,
        170.78,
        173.14,
        24875471.0,
        0.0,
        1.0,
        170.78,
        173.7,
        170.78,
        173.14,
        24875471.0
      ],
      [
        "2017-11-20",
        170.29,
        170.56,
        169.56,
        169.98,
        15974387.0,
        0.0,
        1.0,
        170.29,
        170.56,
        169.56,
        169.98,
        15974387.0
      ],
      [
        "2017-11-17",
        171.04,
        171.39,
        169.64,
        170.15,
        21665811.0,
        0.0,
        1.0,
        171.04,
        171.39,
        169.64,
        170.15,
        21665811.0
      ],
      [
        "2017-11-16",
        171.18,
        171.87,
        170.3,
        171.1,
        23497326.0,
        0.0,
        1.0,
        171.18,
        171.87,
        170.3,
        171.1,
        23497326.0
      ],
      [
        "2017-11-15",
        169.97,
        170.3197,
        168.38,
        169.08,
        28702351.0,
        0.0,
        1.0,
        169.97,
        170.3197,
        168.38,
        169.08,
        28702351.0
      ],
      [
        "2017-11-14",
        173.04,
        173.48,
        171.18,
        171.34,
        23588451.0,
        0.0,
        1.0,
        173.04,
        173.48,
        171.18,
        171.34,
        23588451.0
      ],
      [
        "2017-11-13",
        173.5,
        174.5,
        173.4,
        173.97,
        16828025.0,
        0.0,
        1.0,
        173.5,
        174.5,
        173.4,
        173.97,
        16828025.0
      ],
      [
        "2017-11-10",
        175.11,
        175.38,
        174.27,
        174.67,
        25061183.0,
        0.0,
        1.0,
        175.11,
        175.38,
        174.27,
        174.67,
        25061183.0
      ],
      [
        "2017-11-09",
        175.11,
        176.095,
        173.14,
        175.88,
        28636531.0,
        0.0,
        1.0,
        175.11,
        176.095,
        173.14,
        175.88,
        28636531.0
      ],
      [
        "2017-11-07",
        173.91,
        175.25,
        173.6,
        174.81,
        23910914.0,
        0.0,
        1.0,
        173.91,
        175.25,
        173.6,
        174.81,
        23910914.0
      ],
      [
        "2017-11-06",
        172.365,
        174.99,
        171.72,
        174.25,
        34242566.0,
        0.0,
        1.0,
        172.365,
        174.99,
        171.72,
        174.25,
        34242566.0
      ],
      [
        "2017-11-03",
        174.0,
        174.26,
        171.12,
        172.5,
        58683826.0,
        0.0,
        1.0,
        174.0,
        174.26,
        171.12,
        172.5,
        58683826.0
      ],
      [
        "2017-11-02",
        167.64,
        168.5,
        165.28,
        168.11,
        32710040.0,
        0.0,
        1.0,
        167.64,
        168.5,
        165.28,
        168.11,
        32710040.0
      ],
      [
        "2017-11-01",
        169.87,
        169.94,
        165.61,
        166.89,
        33100847.0,
        0.0,
        1.0,
        169.87,
        169.94,
        165.61,
        166.89,
        33100847.0
      ]
    ],
    "collapse": null,
    "order": null,
    "database_id": 4922
  }
}
*/
